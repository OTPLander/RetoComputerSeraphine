<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room Monitor - Tecnun</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="white-section">
        <div class="header-container">
            {% if current_user.is_authenticated and current_user.is_admin %}
            <div class="admin-link">
                <a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a>
            </div>
            {% endif %}

            <div class="logo-title">
                <img src="{{ url_for('static', filename='images/tecnun-logo.png') }}" alt="Tecnun Logo" class="logo">
                <h1>Study Room Monitor</h1>
            </div>

            {% if current_user.is_authenticated %}
            <div class="user-links">
                <a href="{{ url_for('my_reservations') }}" class="user-link">My Reservations</a>
                <a href="{{ url_for('logout') }}" class="user-link">Logout</a>
            </div>
            {% endif %}
        </div>
    </header>

    <main>
        <section class="white-section">
            <div class="content-wrapper">
                <h2>Available Study Rooms</h2>
                <p class="subtitle">Select a room to view current status and reserve time slots</p>

                <div class="rooms-grid">
                    {% for classroom in classrooms %}
                    <div class="room-card" data-room-id="{{ classroom.id }}" data-room-name="{{ classroom.name }}">
                        <div class="room-color" style="background-color: {{ classroom.color }}"></div>
                        <h3>{{ classroom.name }} Room</h3>
                        <div class="room-status {% if classroom.is_occupied %}occupied{% else %}available{% endif %}">
                            {% if classroom.is_occupied %}Occupied{% else %}Available{% endif %}
                        </div>
                        <div class="sound-level">
                            <div class="level-bar" style="width: {{ classroom.noise_level }}%"></div>
                            <span>{{ classroom.noise_level }} dB</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        {# Removed Room Details Section #}
        {# Removed Usage Statistics Section #}

    </main>

    <footer class="red-section">
        <div class="content-wrapper">
            <p>Â© 2025 Tecnun - University of Navarra</p>
        </div>
    </footer>

    {# Modal structure with aria-hidden attribute - MODIFIED #}
    <div id="reservationModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modalRoomName"></h3>
            <input type="date" id="reservationDate" min="{{ datetime.today().strftime('%Y-%m-%d') }}"> {# Set min date using Jinja #}
            <div class="time-slots-container" id="timeSlots">
            </div>
            <button id="confirmReservationBtn" style="display: none; margin-top: 20px; padding: 10px; background-color: var(--tecnun-red); color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Confirm Reservation</button>
            <p id="modalMessage" style="margin-top: 10px; text-align: center;"></p>
        </div>
    </div>


    <script>
        // Franjas horarias definidas - Kept for reference, but API will provide availability
        const TIME_SLOTS_REF = [
            { start: '09:00', end: '10:30', label: '9:00 - 10:30' },
            { start: '10:30', end: '12:00', label: '10:30 - 12:00' },
            { start: '12:00', end: '13:30', label: '12:00 - 13:30' },
            { start: '13:30', end: '15:00', label: '13:30 - 15:00' },
            { start: '15:00', end: '16:30', label: '15:00 - 16:30' },
            { start: '16:30', end: '18:00', label: '16:30 - 18:00' },
            { start: '18:00', end: '19:30', label: '18:00 - 19:30' }
        ];

        // Get references to modal elements
        const modal = document.getElementById("reservationModal");
        const span = document.getElementsByClassName("close-btn")[0];
        const modalRoomName = document.getElementById("modalRoomName");
        const timeSlotsContainer = document.getElementById("timeSlots");
        const reservationDateInput = document.getElementById("reservationDate");

        // NEW: Get references to the new button and message elements
        const confirmReservationBtn = document.getElementById("confirmReservationBtn");
        const modalMessage = document.getElementById("modalMessage");

        // NEW: Variable to store the selected time slot data
        let selectedSlotData = null;


        // Function to open modal and fetch time slots
        function openReservationModal(roomId, roomName) {
            // Clear previous selection and message when opening modal
            selectedSlotData = null;
            confirmReservationBtn.style.display = 'none';
            modalMessage.textContent = '';
            modalMessage.style.color = '';
             document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });


            modal.style.display = "flex"; // Use flex to center
            modal.setAttribute('aria-hidden', 'false'); // Indicate modal is visible for accessibility
            modalRoomName.textContent = `Reserve ${roomName} Room`;

            // Set default date to today and fetch slots
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            reservationDateInput.value = formattedDate; // Set the value of the date input
            // Set min attribute for date input - also done in Jinja, but good to set with JS too
            reservationDateInput.min = formattedDate;


            fetchAvailableSlots(roomId, formattedDate);

            // Store room ID for later use on the modal element itself
            modal.dataset.roomId = roomId;
        }

        // Function to fetch and display available time slots for a given room and date
        function fetchAvailableSlots(roomId, date) {
             // Clear existing slots and show loading or message
            timeSlotsContainer.innerHTML = '<p>Loading time slots...</p>';
            selectedSlotData = null; // Clear selected data on date change
            confirmReservationBtn.style.display = 'none'; // Hide confirm button on date change
            modalMessage.textContent = ''; // Clear messages on date change
            modalMessage.style.color = ''; // Reset message color

            fetch(`/api/room/${roomId}/availability?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    timeSlotsContainer.innerHTML = ''; // Clear previous slots
                    if (data.available_slots.length > 0) {
                        data.available_slots.forEach(slot => {
                            const slotElement = document.createElement('div');
                            slotElement.classList.add('time-slot');
                            slotElement.textContent = slot.label;
                            // Data attributes are useful, but for the POST request, we'll send the label
                            slotElement.dataset.startTime = slot.start;
                            slotElement.dataset.endTime = slot.end;

                            // Add click listener to each time slot
                            slotElement.addEventListener('click', () => selectTimeSlot(slotElement, roomId, date));
                            timeSlotsContainer.appendChild(slotElement);
                        });
                    } else {
                        timeSlotsContainer.innerHTML = '<p>No available slots for this date.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching available slots:', error);
                    timeSlotsContainer.innerHTML = '<p style="color: red;">Error loading time slots.</p>'; // Indicate error
                });
        }

        // Function to handle time slot selection (MODIFIED)
        function selectTimeSlot(slotElement, roomId, date) {
            // Remove 'selected' class from all time slots first
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // Add 'selected' class to the clicked slot
            slotElement.classList.add('selected');

            // Store the selected slot data - only need date and label for the POST request
            selectedSlotData = {
                date: date,
                label: slotElement.textContent // Store the text content (label)
            };

            // Show the confirm button and clear any previous messages
            confirmReservationBtn.style.display = 'block';
            modalMessage.textContent = ''; // Clear any previous error messages
            modalMessage.style.color = ''; // Reset message color
        }

        // Add event listener for the new Confirm Reservation button (NEW AJAX CALL)
        confirmReservationBtn.addEventListener('click', function() {
            if (!selectedSlotData) {
                modalMessage.style.color = 'red';
                modalMessage.textContent = 'Please select a time slot.';
                return; // Stop if no slot is selected
            }

            const roomId = modal.dataset.roomId; // Get the room ID stored on the modal

            // Prepare the data to send in the POST request
            const formData = new FormData();
            formData.append('date', selectedSlotData.date);
            formData.append('time_slot', selectedSlotData.label); // Send the time slot label

            // Disable the button and show a loading indicator (optional but good UX)
            confirmReservationBtn.disabled = true;
            confirmReservationBtn.textContent = 'Reserving...';
            modalMessage.textContent = ''; // Clear previous messages

            // Perform the AJAX POST request using the Fetch API
            fetch(`/reserve/${roomId}`, {
                method: 'POST', // Send as a POST request
                body: formData  // Send the form data
            })
            .then(response => {
                // Check if the response was successful (status 200-299)
                if (!response.ok) {
                     // If not OK, throw an error that includes the response
                    return response.json().then(err => {
                        const error = new Error(err.message || 'Reservation failed');
                        error.status = response.status;
                        error.responseJson = err; // Attach the parsed JSON error response
                        throw error;
                    });
                }
                // If OK, parse the JSON success response
                return response.json();
            })
            .then(data => {
                // Handle the JSON response from the server (status === 'success')
                modalMessage.style.color = 'green';
                modalMessage.textContent = data.message + " Redirecting...";

                // Redirect to the my_reservations page after a short delay
                setTimeout(() => {
                    window.location.href = "{{ url_for('my_reservations') }}";
                }, 1500); // Redirect after 1.5 seconds

            })
            .catch(error => {
                // Handle network errors or errors thrown from the .then blocks
                console.error('Reservation failed:', error);
                modalMessage.style.color = 'red';

                // Display the specific error message from the server if available,
                // otherwise show a generic message.
                if (error.responseJson && error.responseJson.message) {
                     modalMessage.textContent = error.responseJson.message;
                } else {
                    modalMessage.textContent = error.message || 'An unexpected error occurred during reservation.';
                }

                 // Optional: Re-fetch available slots on error, as the slot might have been taken
                 // by someone else simultaneously (409 Conflict)
                 const roomId = modal.dataset.roomId;
                 const selectedDate = reservationDateInput.value;
                 if (roomId && selectedDate) {
                      fetchAvailableSlots(roomId, selectedDate);
                 }
            })
            .finally(() => {
                // Re-enable the button regardless of success or failure
                confirmReservationBtn.disabled = false;
                confirmReservationBtn.textContent = 'Confirm Reservation';
                // Keep modal open on error to show message; will close on success redirect.
            });
        });


        // Close the modal when the 'x' is clicked
        span.onclick = function () {
            modal.style.display = "none";
            modal.setAttribute('aria-hidden', 'true'); // Indicate modal is hidden for accessibility
        }

        // Close the modal when clicking outside of it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
                modal.setAttribute('aria-hidden', 'true'); // Indicate modal is hidden for accessibility
            }
        }

        // Add event listeners to room cards to open the modal
        document.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', function () {
                const roomId = this.dataset.roomId; // Get room ID from data attribute
                const roomName = this.dataset.roomName; // Get room name from data attribute
                openReservationModal(roomId, roomName); // Call the function to open the modal
            });
        });

        // Event listener for date input changes to update available slots
        reservationDateInput.addEventListener('change', function () {
            const selectedDate = this.value;
            const roomId = modal.dataset.roomId; // Get room ID from modal dataset
            if (roomId && selectedDate) {
                fetchAvailableSlots(roomId, selectedDate);
            }
        });


        // Update room status periodically
        function updateRoomStatus() {
            fetch('/api/rooms/status')
                .then(response => response.json())
                .then(data => {
                    // Update status of each room card
                    data.rooms.forEach(room => {
                        const roomElement = document.querySelector(`.room-card[data-room-id="${room.id}"]`);
                        if (roomElement) {
                            const statusElement = roomElement.querySelector('.room-status');
                            const soundElement = roomElement.querySelector('.sound-level .level-bar');

                            // Update status text and class
                            statusElement.className = `room-status ${room.is_occupied ? 'occupied' : 'available'}`;
                            statusElement.textContent = room.is_occupied ? 'Occupied' : 'Available';

                            // Update sound level
                            soundElement.style.width = `${room.noise_level}%`;
                            soundElement.nextElementSibling.textContent = `${room.noise_level} dB`;
                        }
                    });
                })
                .catch(error => {
                     console.error('Error updating room status:', error);
                     // Optionally display a message on the page about the update error
                });
        }

        // Update every 30 seconds
        setInterval(updateRoomStatus, 30000);

        // Initial updates when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateRoomStatus(); // Initial update of room statuses

            // Set min date for the date picker
            const today = new Date().toISOString().split('T')[0];
            reservationDateInput.min = today;
        });

    </script>
</body>
</html>