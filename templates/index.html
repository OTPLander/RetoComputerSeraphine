<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room Monitor - Tecnun</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="white-section">
        <div class="header-container">
            {% if current_user.is_authenticated and current_user.is_admin %}
            <div class="admin-link">
                <a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a>
            </div>
            {% endif %}

            <div class="logo-title">
                <img src="{{ url_for('static', filename='images/tecnun-logo.png') }}" alt="Tecnun Logo" class="logo">
                <h1>Study Room Monitor</h1>
            </div>

            {% if current_user.is_authenticated %}
            <div class="user-links">
                <a href="{{ url_for('my_reservations') }}" class="user-link">My Reservations</a>
                <a href="{{ url_for('logout') }}" class="user-link">Logout</a>
            </div>
            {% endif %}
        </div>
    </header>

    <main>
        <section class="white-section">
            <div class="content-wrapper">
                <h2>Available Study Rooms</h2>
                <p class="subtitle">Select a room to view current status and reserve time slots</p>

                <div class="rooms-grid">
                    {% for classroom in classrooms %}
                    <div class="room-card" data-room-id="{{ classroom.id }}" data-room-name="{{ classroom.name }}">
                        <div class="room-color" style="background-color: {{ classroom.color }}"></div>
                        <h3>{{ classroom.name }} Room</h3>
                        <div class="room-status {% if classroom.is_occupied %}occupied{% else %}available{% endif %}">
                            {% if classroom.is_occupied %}Occupied{% else %}Available{% endif %}
                        </div>
                        <div class="sound-level">
                            <div class="level-bar" style="width: {{ classroom.noise_level }}%"></div>
                            <span>{{ classroom.noise_level }} dB</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        {# Removed Room Details Section #}
        {# Removed Usage Statistics Section #}

    </main>

    <footer class="red-section">
        <div class="content-wrapper">
            <p>Â© 2025 Tecnun - University of Navarra</p>
        </div>
    </footer>

    {# Modal structure with aria-hidden attribute #}
    <div id="reservationModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modalRoomName"></h3>
            <input type="date" id="reservationDate" min="{{ today }}">
            <div class="time-slots-container" id="timeSlots">
            </div>
        </div>
    </div>


    <script>
        // Franjas horarias definidas - Kept for reference, but API will provide availability
        const TIME_SLOTS_REF = [
            { start: '09:00', end: '10:30', label: '9:00 - 10:30' },
            { start: '10:30', end: '12:00', label: '10:30 - 12:00' },
            { start: '12:00', end: '13:30', label: '12:00 - 13:30' },
            { start: '13:30', end: '15:00', label: '13:30 - 15:00' },
            { start: '15:00', end: '16:30', label: '15:00 - 16:30' },
            { start: '16:30', end: '18:00', label: '16:30 - 18:00' },
            { start: '18:00', end: '19:30', label: '18:00 - 19:30' }
        ];

        const modal = document.getElementById("reservationModal");
        const span = document.getElementsByClassName("close-btn")[0];
        const modalRoomName = document.getElementById("modalRoomName");
        const timeSlotsContainer = document.getElementById("timeSlots");
        const reservationDateInput = document.getElementById("reservationDate");


        // Function to open modal and fetch time slots
        function openReservationModal(roomId, roomName) {
            modal.style.display = "flex"; // Use flex to center
            modal.setAttribute('aria-hidden', 'false'); // Indicate modal is visible for accessibility
            modalRoomName.textContent = `Reserve ${roomName} Room`;

            // Set default date to today and fetch slots
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            reservationDateInput.value = formattedDate;
            fetchAvailableSlots(roomId, formattedDate);

            // Store room ID for later use
            modal.dataset.roomId = roomId;
        }

        // Function to fetch and display available time slots for a given room and date
        function fetchAvailableSlots(roomId, date) {
            fetch(`/api/room/${roomId}/availability?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    timeSlotsContainer.innerHTML = ''; // Clear previous slots
                    if (data.available_slots.length > 0) {
                        data.available_slots.forEach(slot => {
                            const slotElement = document.createElement('div');
                            slotElement.classList.add('time-slot');
                            slotElement.textContent = slot.label;
                            slotElement.dataset.startTime = slot.start; // Store start time
                            slotElement.dataset.endTime = slot.end; // Store end time
                            slotElement.addEventListener('click', () => selectTimeSlot(slotElement, roomId, date));
                            timeSlotsContainer.appendChild(slotElement);
                        });
                    } else {
                        timeSlotsContainer.innerHTML = '<p>No available slots for this date.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching available slots:', error);
                    timeSlotsContainer.innerHTML = '<p>Error loading time slots.</p>';
                });
        }

        // Function to handle time slot selection
        function selectTimeSlot(slotElement, roomId, date) {
            const startTime = slotElement.dataset.startTime;
            const endTime = slotElement.dataset.endTime;

            // Construct the full datetime strings
            const startDatetime = `${date} ${startTime}`;
            const endDatetime = `${date} ${endTime}`;


            // Redirect to the reservation page with pre-selected values
            window.location.href = `/reserve/${roomId}?date=${date}&time_slot=${slotElement.textContent}`;
        }


        // Close the modal
        span.onclick = function () {
            modal.style.display = "none";
            modal.setAttribute('aria-hidden', 'true'); // Indicate modal is hidden for accessibility
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
                modal.setAttribute('aria-hidden', 'true'); // Indicate modal is hidden for accessibility
            }
        }

        // Add event listeners to room cards
        document.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', function () {
                const roomId = this.dataset.roomId;
                const roomName = this.dataset.roomName;
                openReservationModal(roomId, roomName);
            });
        });

        // Event listener for date input changes
        reservationDateInput.addEventListener('change', function () {
            const selectedDate = this.value;
            const roomId = modal.dataset.roomId; // Get room ID from modal dataset
            if (roomId) {
                fetchAvailableSlots(roomId, selectedDate);
            }
        });


        // Update room status periodically
        function updateRoomStatus() {
            fetch('/api/rooms/status')
                .then(response => response.json())
                .then(data => {
                    // Note: The following lines updated the removed sections.
                    // They are commented out as the sections are removed.
                    // document.getElementById('avgOccupancy').textContent = data.avg_occupancy + '%';
                    // document.getElementById('avgSoundLevel').textContent = data.avg_sound_level + ' dB';
                    // document.getElementById('peakHours').textContent = data.peak_hours;

                    // Actualizar estado de las salas
                    data.rooms.forEach(room => {
                        const roomElement = document.querySelector(`.room-card[data-room-id="${room.id}"]`);
                        if (roomElement) {
                            const statusElement = roomElement.querySelector('.room-status');
                            const soundElement = roomElement.querySelector('.sound-level .level-bar');

                            // Update status text and class
                            statusElement.className = `room-status ${room.is_occupied ? 'occupied' : 'available'}`;
                            statusElement.textContent = room.is_occupied ? 'Occupied' : 'Available';

                            // Update sound level
                            soundElement.style.width = `${room.noise_level}%`;
                            soundElement.nextElementSibling.textContent = `${room.noise_level} dB`;
                        }
                    });
                });
        }

        // Update every 30 seconds
        setInterval(updateRoomStatus, 30000);
        document.addEventListener('DOMContentLoaded', () => {
            updateRoomStatus(); // Initial update
            // Set min date for the date picker
            const today = new Date().toISOString().split('T')[0];
            reservationDateInput.min = today;
        });

    </script>
</body>
</html>