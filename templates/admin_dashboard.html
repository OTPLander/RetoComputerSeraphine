<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Study Room Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Add any specific styles for the new table here if needed,
           but try to reuse existing .admin-table styles */
        /* Optional: Add some styling for the raw data cell to prevent it from stretching the table too much */
        .raw-data-cell { /* Keeping the class name but it might not be needed if raw_data is removed */
            max-width: 200px; /* Adjust as needed */
            overflow-x: auto; /* Add horizontal scroll if content overflows */
            word-break: break-all; /* Break long words */
        }

        /* Styling for the graphs container */
        .graphs-container {
            display: flex; /* Use flexbox for layout */
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            justify-content: center; /* Center items horizontally */
            gap: 20px; /* Add space between graph images */
            margin-top: 30px;
            text-align: center; /* Center the heading */
        }

        .graphs-container img {
            max-width: 100%; /* Ensure images are responsive */
            height: auto; /* Maintain aspect ratio */
            border: 1px solid #ddd; /* Optional: Add a border */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); /* Optional: Add a subtle shadow */
        }
    </style>
</head>
<body>
    <header class="white-section">
        <div class="header-container">
            <img src="{{ url_for('static', filename='images/tecnun-logo.png') }}" alt="Tecnun Logo" class="logo">
            <h1>Admin Dashboard</h1>
            {# Add a link styled as a button to navigate to the index page #}
            <a href="{{ url_for('index') }}" class="button small">Back to Rooms</a>
        </div>
    </header>

    <main>
        {# SECTION FOR USER MANAGEMENT #}
        <section class="white-section">
            <div class="content-wrapper">
                <h2>User Management</h2>
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Admin</th>
                                <th>Active</th> {# Added Active column #}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                                <td>{{ 'Yes' if user.is_active else 'No' }}</td> {# Display Active status #}
                                <td class="actions">
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="button small">Edit</a>
                                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display: inline-block;">
                                        <button type="submit" class="button small" onclick="return confirm('Are you sure you want to delete this user?');">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        {# SECTION FOR RESERVATION MANAGEMENT #}
        <section class="white-section">
            <div class="content-wrapper">
                <h2>Reservation Management</h2>

                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Classroom</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>{{ reservation.id }}</td>
                                <td>{{ reservation.user.username if reservation.user else 'N/A' }}</td> {# Display username #}
                                <td>{{ reservation.classroom.name if reservation.classroom else 'N/A' }}</td> {# Display classroom name #}
                                <td>{{ reservation.start_time.strftime('%Y-%m-%d %H:%M') }}</td> {# Format datetime #}
                                <td>{{ reservation.end_time.strftime('%Y-%m-%d %H:%M') }}</td>   {# Format datetime #}
                                <td class="actions">
                                    
                                    <form action="{{ url_for('cancel_reservation', reservation_id=reservation.id) }}" method="POST" style="display: inline-block;">
                                        <button type="submit" class="button small danger" onclick="return confirm('Are you sure you want to delete this reservation?');">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        {# SECTION FOR MIOTY DATA FROM EXCEL #}
        <section class="white-section">
            <div class="content-wrapper">
                <h2>Mioty Data from Excel</h2> {# Updated title #}


                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                {# Updated headers to match MiotyData model #}
                                <th>Sample Date</th>
                                <th>Sample Hour</th>
                                <th>Student ID</th>
                                <th>Temperature (°C)</th>
                                <th>Luminosity (Lux)</th>
                                <th>Noise (dB)</th>
                                
                            </tr>
                        </thead>
                        <tbody>
                            {% if messages %} {# 'messages' variable now contains paginated MiotyData objects #}
                            {% for data_entry in messages %} {# Renamed loop variable for clarity #}
                            <tr>
                                {# Accessing attributes from MiotyData object #}
                                <td>{{ data_entry.sample_date if data_entry.sample_date is not none else 'N/A' }}</td>
                                <td>{{ data_entry.sample_hour if data_entry.sample_hour is not none else 'N/A' }}</td>
                                <td>{{ data_entry.student_id if data_entry.student_id is not none else 'N/A' }}</td>
                                {# Formatting float values to 2 decimal places #}
                                <td>{{ "%.2f"|format(data_entry.temperature) if data_entry.temperature is not none else 'N/A' }}</td>
                                <td>{{ "%.2f"|format(data_entry.luminosity) if data_entry.luminosity is not none else 'N/A' }}</td>
                                <td>{{ "%.2f"|format(data_entry.noise) if data_entry.noise is not none else 'N/A' }}</td>

                                </td>
                            </tr>
                            {% endfor %}
                            {% else %} {# Display message if no data is available #}
                            <tr>
                                {# Updated colspan to match the new number of columns (7 including Actions) #}
                                <td colspan="7" style="text-align: center;">No Mioty data found in the database.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                {# Pagination Controls for Mioty Data #}
                <div class="pagination" style="text-align: center; margin-top: 20px;">
                    {% if mioty_data_pagination.has_prev %}
                    <a href="{{ url_for('admin_dashboard', mioty_page=mioty_data_pagination.prev_num) }}">Previous</a>
                    {% endif %}
                    <span>Page {{ mioty_data_pagination.page }} of {{ mioty_data_pagination.pages }}</span>
                    {% if mioty_data_pagination.has_next %}
                    <a href="{{ url_for('admin_dashboard', mioty_page=mioty_data_pagination.next_num) }}">Next</a>
                    {% endif %}
                </div>

            </div>
        </section>

        {# Section for Graphs #}
        <section class="white-section">
            <div class="content-wrapper">
                {# Title for the section - placed outside the flex container for alignment #}
                <h2>Data Visualizations</h2>

                {# Container using flexbox to lay out the button and the graph area #}
                <div class="graphs-section-layout">
                    {# Container specifically for the refresh button - ensures it stays to the left #}
                    <div class="refresh-button-container">
                        {# Form for the Refresh Graphs button - using the existing 'button' class #}
                        <form action="{{ url_for('refresh_graphs') }}" method="post" class="refresh-graphs-form">
                            <button type="submit" class="button">Refresh Graphs</button>
                        </form>
                    </div>

                    {# The main area displaying the graphs and navigation #}
                    <div class="graph-viewer">
                        {# graph-items container is used by JS to hold images #}
                        <div class="graph-items">
                            {# Graph blocks remain the same - ensure these use the correct keys #}
                            {# Occupancy by Period Graph #}
                            {% if graph_urls and graph_urls.occupancy_by_period %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.occupancy_by_period }}" alt="Occupancy by Period Plot">
                            </div>
                            {% endif %}

                            {# Temperature on 1-May-2025 Graph #}
                            {% if graph_urls and graph_urls.temperature_may1_2025 %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.temperature_may1_2025 }}" alt="Temperature on 1-May-2025 Plot">
                            </div>
                            {% endif %}

                            {# Temperature on 5-May-2025 Graph #}
                            {% if graph_urls and graph_urls.temperature_may5_2025 %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.temperature_may5_2025 }}" alt="Temperature on 5-May-2025 Plot">
                            </div>
                            {% endif %}

                            {# Luminosity on 9-May-2025 Graph #}
                            {% if graph_urls and graph_urls.luminosity_may9_2025 %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.luminosity_may9_2025 }}" alt="Luminosity on 9-May-2025 Plot">
                            </div>
                            {% endif %}

                            {# Noise on 1-May-2025 Graph #}
                            {% if graph_urls and graph_urls.noise_may1_2025 %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.noise_may1_2025 }}" alt="Noise on 1-May-2025 Plot">
                            </div>
                            {% endif %}

                            {# Average Environmental Factors Graph #}
                            {% if graph_urls and graph_urls.average_environmental_factors %}
                            <div class="graph-item">
                                <img src="{{ graph_urls.average_environmental_factors }}" alt="Average Environmental Factors Plot">
                            </div>
                            {% endif %}

                            {# Fallback message if no graphs were successfully generated #}
                            {% set generated_graph_count = (
                            (graph_urls.occupancy_by_period is not none) +
                            (graph_urls.temperature_may1_2025 is not none) +
                            (graph_urls.temperature_may5_2025 is not none) +
                            (graph_urls.luminosity_may9_2025 is not none) +
                            (graph_urls.noise_may1_2025 is not none) +
                            (graph_urls.average_environmental_factors is not none)
                            ) %}
                            {% if generated_graph_count == 0 %}
                            <p class="graph-message">Could not generate any graphs (check server logs for errors).</p> {# Added class #}
                            {% endif %}
                        </div>

                        {# Navigation Buttons #}
                        {# Show navigation only if there are graphs to display #}
                        {% if generated_graph_count > 1 %}
                        <div class="graph-navigation">
                            {# Removed inline style #}
                            <button id="prevGraphBtn" class="button small">Previous</button>
                            <span id="graphCounter"></span>
                            <button id="nextGraphBtn" class="button small">Next</button>
                        </div>
                        {% endif %}

                        {# Message if only one graph exists, so navigation is hidden #}
                        {% if generated_graph_count == 1 %}
                        <p class="graph-message">(Only one graph available)</p> {# Added class and removed inline style #}
                        {% endif %}

                    </div> {# End graph-viewer #}
                </div> {# End graphs-section-layout #}
            </div>
        </section>
        {# End Section for Graphs #}


    </main>

    <footer class="red-section">
        <div class="content-wrapper">
            <p>© 2025 Tecnun - University of Navarra</p>
        </div>
    </footer>

    <style>
        /* Optional: Add some styling for the raw data cell to prevent it from stretching the table too much */
        /* This style might not be necessary anymore if raw_data is removed */
        .raw-data-cell {
            max-width: 200px; /* Adjust as needed */
            overflow-x: auto; /* Add horizontal scroll if content overflows */
            word-break: break-all; /* Break long words */
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const graphItems = document.querySelectorAll('.graph-item img');
            const prevBtn = document.getElementById('prevGraphBtn');
            const nextBtn = document.getElementById('nextGraphBtn');
            const graphCounter = document.getElementById('graphCounter');
            let currentIndex = 0;

            function showGraph(index) {
                graphItems.forEach((item, i) => {
                    item.style.display = (i === index) ? 'block' : 'none';
                });
                 graphCounter.textContent = `Graph ${index + 1} of ${graphItems.length}`;
                 prevBtn.disabled = (index === 0);
                 nextBtn.disabled = (index === graphItems.length - 1);
            }

            // Show the first graph on page load
            if (graphItems.length > 0) {
                showGraph(currentIndex);
            } else {
                // Hide navigation if no graphs are available
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                 graphCounter.style.display = 'none';
            }


            // Event listeners for navigation buttons
            nextBtn.addEventListener('click', function() {
                if (currentIndex < graphItems.length - 1) {
                    currentIndex++;
                    showGraph(currentIndex);
                }
            });

            prevBtn.addEventListener('click', function() {
                if (currentIndex > 0) {
                    currentIndex--;
                    showGraph(currentIndex);
                }
            });
        });
    </script>
</body>
</html>
